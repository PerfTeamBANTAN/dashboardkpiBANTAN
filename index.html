
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Team Performance</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f9f9f9;
    }
    .navbar-brand {
      font-weight: bold;
      font-size: 24px;
      color: #444;
    }
    .nav-link {
      color: #333;
    }
    .dropdown-menu a {
      font-size: 14px;
    }
    .dropdown-submenu {
      position: relative;
    }
    .dropdown-submenu > .dropdown-menu {
      top: 0;
      left: 100%;
      margin-left: 0.1rem;
      margin-right: 0.1rem;
    }
    
    .dropdown-submenu:hover > .dropdown-menu {
      display: block;
    }
    .card {
      box-shadow: 0 0 15px rgba(0,0,0,0.05);
      border-radius: 15px;
    }
    .highlight-box {
      background: white;
      padding: 15px;
      border-radius: 10px;
    }
    .card-header-indikator {
    background-color: #7F7FFD;
  }
    .card-body.bg-green { background-color: #d4edda; border: 2px solid #28a745; }
    .card-body.bg-yellow { background-color: #fff3cd; border: 2px solid #ffc107; }
    .card-body.bg-red { background-color: #f8d7da; border: 2px solid #dc3545; }
    .card-body.bg-orange { background-color: #ffe5b4; border: 2px solid #fd7e14; }
    .card:hover .card-body { transform: scale(1.03); cursor: pointer; transition: transform 0.2s ease-in-out; 
  }
    .card { border-radius: .75rem; }
  .card-header { font-size: 1.1rem; letter-spacing: 0.5px; }
  table th, table td { vertical-align: middle; }
  </style>
  
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
    <div class="container-fluid">
      <a class="navbar-brand" href="#"><img src="PERFORMANCE TEAM.png" style="height: 40px; margin-right: 10px;">PERFORMANCE BAN-TAN</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" href="#" onclick="loadPiLaten12()">Dashboards</a>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="racingDropdown" role="button" data-bs-toggle="dropdown">Racing</a>
            <ul class="dropdown-menu">
	      <li><a class="dropdown-item" href="#" onclick="showNotAvailable()">Revenue TAN-BAN</a></li>
              <li><a class="dropdown-item" href="#" onclick="loadData('Racing Mitra')">Racing Mitra</a></li>
              <li><a class="dropdown-item" href="#" onclick="loadData('Racing HSA')">Racing HSA</a></li>
              <li><a class="dropdown-item" href="#" onclick="loadData('Racing IOAN Mitra')">Racing IOAN Mitra</a></li>
	            <li><a class="dropdown-item" href="#" onclick="loadData('Dashboard PI laten')">Dashboard PI laten</a></li>
              <li><a class="dropdown-item" href="#" onclick="loadData('Dashboard IOAN B2C')">Dashboard IOAN B2C</a></li>
              <li><a class="dropdown-item" href="#" onclick="showNotAvailable()">Dashboard Non IOAN B2B</a></li>
              <li><a class="dropdown-item" href="#" onclick="showNotAvailable()">Dashboard WSA</a></li>
              <li><a class="dropdown-item" href="#" onclick="showNotAvailable()">Dashboard MSA</a></li>
              <li><a class="dropdown-item" href="#" onclick="showNotAvailable()">Dashboard MAINTENANCE</a></li>
              <li><a class="dropdown-item" href="#" onclick="loadLaporanWA()">Laporan WA</a></li>
              <li><a class="dropdown-item" href="#" onclick="showNotAvailable()">Input Indikator NOTACH</a></li>
            </ul>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="kpiioanDropdown" role="button" data-bs-toggle="dropdown">KPI IOAN</a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#" onclick="loadSummaryTiket()">Summary tiket B2C</a></li>
              <li><a class="dropdown-item" href="#" onclick="loadServiceAvailability()">Service Availability</a></li>
              <li><a class="dropdown-item" href="#" onclick="loadAsgarIoan()">Assurance Guarantee</a></li>
              <li><a class="dropdown-item" href="#" onclick="loadTtrIoan()">TTR</a></li>
              <li><a class="dropdown-item" href="#" onclick="loadUnderspec()">Underspec</a></li>
              <li><a class="dropdown-item" href="#" onclick="loadTangible()">Tangible</a></li>
              <li><a class="dropdown-item" href="#" onclick="showNotAvailable()">Validasi</a></li>
              <li><a class="dropdown-item" href="#" onclick="showNotAvailable()">SQM</a></li>
              <li><a class="dropdown-item" href="#" onclick="loadScc()">SCC</a></li>
              <li><a class="dropdown-item" href="#" onclick="showNotAvailable()">Infracare</a></li>
              <li><a class="dropdown-item" href="#" onclick="showNotAvailable()">Ext Audit</a></li>
            </ul>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="kpi12piDropdown" role="button" data-bs-toggle="dropdown">KPI 12 PI Laten</a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#" onclick="showNotAvailable()">Gamas</a></li>
              <li><a class="dropdown-item" href="#" onclick="showNotAvailable()">PS/RE</a></li>
              <li><a class="dropdown-item" href="#" onclick="showNotAvailable()">Wifi</a></li>
              <li><a class="dropdown-item" href="#" onclick="showNotAvailable()">HSI Datin</a></li>
            </ul>
          </li>
	  <li class="nav-item dropdown">
  <a class="nav-link dropdown-toggle" href="#" id="kpiB2BDropdown" role="button" data-bs-toggle="dropdown">KPI Non Sektor B2B</a>
  <ul class="dropdown-menu">
    <li class="dropdown-submenu dropend">
      <a class="dropdown-item dropdown-toggle" href="#" id="hsiSubmenu" data-bs-toggle="dropdown">HSI</a>
      <ul class="dropdown-menu" aria-labelledby="hsiSubmenu">
        <li><a class="dropdown-item" href="#" onclick="showNotAvailable()">Q HSI</a></li>
        <li><a class="dropdown-item" href="#" onclick="showNotAvailable()">ASGAR HSI</a></li>
        <li><a class="dropdown-item" href="#" onclick="loadTtrHsi()">TTR HSI</a></li>
      </ul>
    </li>
    <li><a class="dropdown-item" href="#" onclick="showNotAvailable()">DATIN</a></li>
    <li><a class="dropdown-item" href="#" onclick="showNotAvailable()">WIFI</a></li>
    <li><a class="dropdown-item" href="#" onclick="showNotAvailable()">OLO</a></li>
  </ul>
</li>
          <li class="nav-item dropdown">
	    <a class="nav-link dropdown-toggle" href="#" id="kpiWSADropdown" role="button" data-bs-toggle="dropdown">KPI WSA</a>
            <ul class="dropdown-menu">
	      <li><a class="dropdown-item" href="#">FFG</a></li>
              <li><a class="dropdown-item" href="#" onclick="showNotAvailable()">TTI</a></li>
              <li><a class="dropdown-item" href="#" onclick="showNotAvailable()">Service Availability</a></li>
              <li><a class="dropdown-item" href="#" onclick="showNotAvailable()">Assurance Guarante</a></li>
	      <li><a class="dropdown-item" href="#">TTR</a></li>
	    </ul>
	  </li>
          <li class="nav-item dropdown">
	    <a class="nav-link dropdown-toggle" href="#" id="kpiMTCDropdown" role="button" data-bs-toggle="dropdown">KPI Maintenance</a>
            <ul class="dropdown-menu">
	      <li><a class="dropdown-item" href="#">FTM</a></li>
              <li><a class="dropdown-item" href="#" onclick="showNotAvailable()">OLT</a></li>
              <li><a class="dropdown-item" href="#" onclick="showNotAvailable()">GAMAS</a></li>
              <li><a class="dropdown-item" href="#" onclick="showNotAvailable()">Pengawasan Project P3</a></li>
	      <li><a class="dropdown-item" href="#" onclick="showNotAvailable()">Patroli Akses</a></li>
        </li>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
   <div id="headerSection" class="text-center mb-4">
  <img src="PERFORMANCE TEAM.png" alt="Performance Team" style="max-height: 80px;">
  <h2>Welcome to PERFORMANCE TEAM Dashboard</h2>
  <p>Live KPI monitoring integrated with Google Sheets Team Performansi</p>
</div>
<div id="loadingSpinner" class="text-center my-5" style="display:none;">
  <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
    <span class="visually-hidden">Loading...</span>
  </div>
  <p class="mt-2">Sedang memuat data...</p>
</div>
<div class="row" id="dashboardContent">
      <!-- Data akan dimuat di sini -->
    </div>
<div id="saTable" class="mt-5"></div>
  </div>

  <script>
  const scriptURL = 'https://script.google.com/macros/s/AKfycbwq85CIdDt06BPp4CayvtOwsjNcTuIAzzsfljN4gEa1m7PA74KbBC9RMmMk-ifltgf0/exec';
	
	function showNotAvailable() {
  showLoading();
  setTimeout(() => {
    hideLoading();
  document.getElementById('headerSection').style.display = 'none';
  document.getElementById('dashboardContent').innerHTML = `
    <div class="text-center text-danger mt-5">
      <div id="headerSection" class="text-center mb-4">
      <img src="under contruction.png" alt="Performance Team" style="width: 100%; max-width: 300px; height: auto;">
      <h4>⚠️ Silakan cek dahulu di spreadsheet-nya hingga proses develop selesai di buat.</h4>
      <p>Silakan cek kembali nanti</p>
    </div>
  `;
}, 800);
}
function showLoading() {
  document.getElementById("dashboardContent").innerHTML = "";
  document.getElementById("loadingSpinner").style.display = "block";
}

function hideLoading() {
  document.getElementById("loadingSpinner").style.display = "none";
}
function loadData(kategori) {
  showLoading();
  document.getElementById('headerSection').style.display = 'none';

  if (kategori.toLowerCase().includes('pi laten')) {
    loadPiLaten();
    return;
  }
  if (kategori.toLowerCase().includes('ioan b2c')) {
    loadKpiB2c();
    return;
  }
  if (kategori.toLowerCase().includes('service availability')) {
    loadServiceAvailability();
    return;
  }
  if (kategori.toLowerCase().includes('summary tiket b2c')) {
    loadServiceAvailability();
    return;
  }
	 if (kategori.toLowerCase().includes('asgar ioan')) {
    loadServiceAvailability();
    return;
  }

  fetch(`${scriptURL}?kategori=${encodeURIComponent(kategori)}`)
    .then(response => {
      if (!response.ok) throw new Error('HTTP error ' + response.status);
      return response.json();
    })
    .then(data => {
      hideLoading();
      const container = document.getElementById('dashboardContent');
      container.innerHTML = '';

      if (data.length === 0) {
        container.innerHTML = '<p class="text-center text-muted">Data tidak ditemukan.</p>';
        return;
      }

      const bulan = getBulanNamaIndonesia();
      const isIOANMitraTable = kategori.toLowerCase().includes('racing ioan mitra');
      const isHsa = kategori.toLowerCase().includes('hsa');
      const isMitraIOAN = kategori.toLowerCase().includes('ioan') && kategori.toLowerCase().includes('mitra');

      let heading = '';
      if (kategori.toLowerCase().includes('mitra')) {
        heading = `▀▄▀▄▀▄ RACING MITRA TANGERANG ${bulan} ▄▀▄▀▄▀`;
      } else if (kategori.toLowerCase().includes('hsa')) {
        heading = `▀▄▀▄▀▄ RACING HSA TANGERANG ${bulan} ▄▀▄▀▄▀`;
      } else {
        heading = `▀▄▀▄▀▄ RACING ${kategori.toUpperCase()} ${bulan} ▄▀▄▀▄▀`;
      }

      // === KHUSUS IOAN MITRA FULL TABEL ===
      if (isIOANMitraTable) {
        let html = `
          <h4 class="text-center fw-bold mb-3">📊 RACING IOAN MITRA - DISTRICT BANTEN</h4>
          <div class="table-responsive">
            <table class="table table-bordered table-striped table-sm text-center align-middle">
        `;

        const headerRow = data[0];
        html += `<thead class="table-dark"><tr>`;
        headerRow.forEach(col => {
          html += `<th>${col}</th>`;
        });
        html += `</tr></thead><tbody>`;

        const bodyRows = data.slice(1);
        bodyRows.forEach(row => {
          html += `<tr>`;
          row.forEach(cell => {
            const value = typeof cell === 'number' ? cell.toFixed(2) : cell;
            html += `<td>${value}</td>`;
          });
          html += `</tr>`;
        });

        html += `</tbody></table></div>`;
        container.innerHTML = html;
        return;
      }

      // === DEFAULT: RACING MITRA / HSA ===
      let html = `
        <h4 class="text-center fw-bold mb-3">${heading}</h4>
        <div class="table-responsive">
          <table class="table table-bordered table-striped table-sm text-center align-middle">
            <thead class="table-dark">
              <tr>
                <th>Nama</th>
                <th>Jumlah Sektor</th>
                <th>Induk GMS</th>
                <th>ZERO GAMS</th>
                <th>ACH ZERO</th>
                <th>REAL 12PI</th>
                <th>ACH 12PI</th>
                <th>REAL KPI</th>
                <th>ACH KPI</th>
                <th>REAL TNPS</th>
                <th>ACH TNPS</th>
                <th>REAL PSB</th>
                <th>ACH PSB</th>
                <th>REALISASI</th>
                <th>RANK</th>
              </tr>
            </thead>
            <tbody>
      `;

      data
        .filter(row => row.nama && row.nama.toString().trim() !== '')
        .forEach(row => {
          html += `
            <tr>
              <td>${row.nama}</td>
              <td>${row.sektor}</td>
              <td>${row.gms}</td>
              <td>${parseFloat(row.zero).toFixed(2)}</td>
              <td>${parseFloat(row.ach_zero).toFixed(2)}</td>
              <td>${parseFloat(row.pi12).toFixed(2)}</td>
              <td>${parseFloat(row.ach_pi12).toFixed(2)}</td>
              <td>${parseFloat(row.kpi).toFixed(2)}</td>
              <td>${parseFloat(row.ach_kpi).toFixed(2)}</td>
              <td>${parseFloat(row.tnps).toFixed(2)}</td>
              <td>${parseFloat(row.ach_tnps).toFixed(2)}</td>
              <td>${parseFloat(row.psb).toFixed(2)}</td>
              <td>${parseFloat(row.ach_psb).toFixed(2)}</td>
              <td>${parseFloat(row.realisasi).toFixed(2)}</td>
              <td>${parseInt(row.rank)}</td>
            </tr>
          `;
        });

      html += `</tbody></table></div>`;

      // === Laporan Ranking Ringkas ===
      const now = new Date();
      const tanggal = now.toLocaleDateString('id-ID');
      const waktu = now.toLocaleTimeString('id-ID');

      let reportJudul = '';
      let reportKolom = '';
      if (isHsa) {
        reportJudul = `▀▄▀▄  *Report Pencapaian RACING HSA TANGERANG* ▄▀▄▀\n==========================`;
        reportKolom = 'REALISASI';
      } else if (isMitraIOAN) {
        reportJudul = `*Report Pencapaian KPI IOAN MITRA DIST (B2C)*`;
        reportKolom = 'ACH';
      } else {
        reportJudul = `*Report Pencapaian RACING ${kategori.toUpperCase()}*`;
        reportKolom = 'REALISASI';
      }

      let reportBody = `\n_Posisi :_  ${tanggal} ${waktu}\nRANK  ${isMitraIOAN ? 'MITRA' : 'HSA'}  ${reportKolom}\n`;

      data
        .filter(row => row.rank && row.nama)
        .sort((a, b) => parseFloat(a.rank) - parseFloat(b.rank))
        .forEach((row, idx, arr) => {
          const isJuara = idx === 0 ? ' 🏆' : '';
          const isTerkahir = idx === arr.length - 1 ? ' ☠️' : '';
          const nilai = isMitraIOAN ? row.ach_kpi : row.realisasi;
          reportBody += `${parseInt(row.rank)}  ${row.nama}  ${parseFloat(nilai).toFixed(2)}${isJuara}${isTerkahir}\n`;
        });

      html += `<pre class="mt-3">${reportJudul}${reportBody}</pre>`;
      container.innerHTML = html;
    })
    .catch(err => {
      hideLoading();
      console.error('Gagal muat:', err);
      document.getElementById('dashboardContent').innerHTML =
        '<p class="text-danger text-center">Gagal memuat data.</p>';
    });
}
function getBulanNamaIndonesia() {
  const bulan = [
    "JANUARI", "FEBRUARI", "MARET", "APRIL", "MEI", "JUNI",
    "JULI", "AGUSTUS", "SEPTEMBER", "OKTOBER", "NOVEMBER", "DESEMBER"
  ];
  const now = new Date();
  return bulan[now.getMonth()];
} 
function loadPiLaten() {
	showLoading();
  const container = document.getElementById('dashboardContent');
  container.innerHTML = `
    <div class="container py-3">
      <h5 class="mb-3">📊 12 PI laten District BANTEN</h5>
      <div class="row row-cols-2 row-cols-md-6 g-3 mb-4" id="summaryCards12"></div>
      <div id="perbandinganTables" class="mb-5"></div>
      <div id="gagalTable" class="mt-4"></div>
    </div>`;

  fetch(`${scriptURL}?kategori=12 pi laten`)
    .then(response => response.json())
    .then(data => {
    	hideLoading();
      renderSummary12Indikator(data);
      renderPerbandinganTables(data);
      renderTabelGagal(data);
    })
    .catch(err => {
    	hideLoading();	
      console.error("Gagal mengambil data PI Laten:", err.message);
      container.innerHTML = '<p class="text-danger text-center">Gagal memuat data 12 PI Laten.</p>';
    });
}

function renderSummary12Indikator(data) {
  const indikatorList = [
    "TTRC Gamas Distribusi", "TTRC Gamas Feeder", "TTRC Gamas ODP", "TTRC 36H FBB", "PS/RE",
    "Latency RAN to Core", "MTTRi Critical", "Wifi Revitalization", "Underspec Waranty HSI",
    "TTRC K2,K1 Datin", "TTRD Non HSI", "Asgar Datin"
  ];

  const container = document.getElementById("summaryCards12");
  if (!container) return;
  container.innerHTML = "";

  indikatorList.forEach(indikator => {
    const key = indikator.toUpperCase().trim();
    const match = data.find(item => (item.INDIKATOR || "").toUpperCase().trim() === key);
    const target = parseFloat(match?.TARGET) || 0;

    const banten = parseFloat(
      data.find(item => (item.INDIKATOR || "").toUpperCase().trim() === key && (item.WITEL || "").toUpperCase().includes("BANTEN"))?.REAL
    ) || 0;
    const tangerang = parseFloat(
      data.find(item => (item.INDIKATOR || "").toUpperCase().trim() === key && (item.WITEL || "").toUpperCase().includes("TANGERANG"))?.REAL
    ) || 0;

    let warna = "bg-green";
    if (banten < target && tangerang < target) {
      warna = "bg-red";
    } else if ((banten < target && tangerang >= target) || (tangerang < target && banten >= target)) {
      warna = "bg-yellow";
    } else if (
      (Math.abs(banten - target) / target <= 0.03 && banten < target) ||
      (Math.abs(tangerang - target) / target <= 0.03 && tangerang < target)
    ) {
      warna = "bg-orange";
    }

    container.innerHTML += `
      <div class="col">
        <div class="card h-100 border-secondary" title="${indikator}\nTarget: ${target}%\nBanten: ${banten}%\nTangerang: ${tangerang}%">
          <div class="card-header text-center card-header-indikator">
            <strong style="font-size: 0.8rem;">${indikator}</strong>
          </div>
          <div class="card-body text-center p-2 ${warna}">
            <p style="font-size: 0.75rem;">
              <strong>Target:</strong> ${target}%<br>
              <span style="color: ${banten < target ? 'red' : 'black'};"><strong>Banten:</strong> ${banten}%</span><br>
              <span style="color: ${tangerang < target ? 'red' : 'black'};"><strong>Tangerang:</strong> ${tangerang}%</span>
              </p>
          </div>
        </div>
      </div>
    `;
  });
}

function renderPerbandinganTables(data) {
  const witelData = { BANTEN: [], TANGERANG: [] };
  data.forEach(item => {
    const witel = (item.WITEL || "").toUpperCase();
    const sto = (item.STO || "").toUpperCase();
    if (witel.includes("BANTEN") && sto === "BANTEN") {
      witelData.BANTEN.push(item);
    } else if (witel.includes("TANGERANG") && sto === "TANGERANG") {
      witelData.TANGERANG.push(item);
    }
  });

  const tableSection = document.getElementById("perbandinganTables");
  if (!tableSection) return;
  tableSection.innerHTML = `
    <div class="row">
      <div class="col-md-6">
        <h6 class="text-center">WITEL TANGERANG</h6>
        <div class="table-responsive">
          <table class="table table-sm table-bordered align-middle">
            <thead class="table-light text-center">
              <tr><th>INDIKATOR</th><th>TARGET</th><th>REAL</th><th>ACH %</th><th>STATUS</th></tr>
            </thead>
            <tbody>
              ${generateTableRowsPiLaten(witelData.TANGERANG)}
            </tbody>
          </table>
        </div>
      </div>
      <div class="col-md-6">
        <h6 class="text-center">WITEL BANTEN</h6>
        <div class="table-responsive">
          <table class="table table-sm table-bordered align-middle">
            <thead class="table-light text-center">
              <tr><th>INDIKATOR</th><th>TARGET</th><th>REAL</th><th>ACH %</th><th>STATUS</th></tr>
            </thead>
            <tbody>
              ${generateTableRowsPiLaten(witelData.BANTEN)}
            </tbody>
          </table>
        </div>
      </div>
    </div>`;
}
function renderTabelGagal(data) {
  const groupedByWitel = {};

  data.forEach(item => {
    const ach = parseFloat(item["ACH %"]) || 0;
    const bobot = parseFloat(item.BOBOT) || 0;
    const indikator = (item.INDIKATOR || "").trim().toUpperCase();
    const sto = (item.STO || "").trim().toUpperCase();
    const hsa = (item.HSA || "").trim().toUpperCase();
    const witel = (item.WITEL || "").trim().toUpperCase();

    // Saring data yang tidak diperlukan
    if (
      indikator === "TOTAL ACH" ||
      sto === "TANGERANG" || sto === "BANTEN" ||
      ach === bobot
    ) return;

    if (!groupedByWitel[witel]) {
      groupedByWitel[witel] = {};
    }

    const key = `${indikator}|${hsa}`;
    if (!groupedByWitel[witel][key]) {
      groupedByWitel[witel][key] = { indikator, hsa, stos: [] };
    }

    if (!groupedByWitel[witel][key].stos.includes(sto)) {
      groupedByWitel[witel][key].stos.push(sto);
    }
  });

  const gagalDiv = document.getElementById("gagalTable");
  if (!gagalDiv) return;

  // Bangun tabel HTML per WITEL
  let html = `<h6 class="text-center text-danger">Indikator dengan Status ❌</h6>`;

  Object.keys(groupedByWitel).sort().forEach(witel => {
    const rows = Object.values(groupedByWitel[witel]).sort((a, b) =>
      a.indikator.localeCompare(b.indikator)
    );

    html += `
      <h6 class="mt-4 text-primary">WITEL ${witel}</h6>
      <div class="table-responsive">
        <table class="table table-sm table-bordered align-middle">
          <thead class="table-danger text-center">
            <tr>
              <th>INDIKATOR</th>
              <th>STO</th>
              <th>HSA</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(item => `
              <tr>
                <td>${item.indikator}</td>
                <td>${item.stos.join(" , ")}</td>
                <td>HSA : ${item.hsa}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      </div>
    `;
  });

  gagalDiv.innerHTML = html;
}

function generateTableRowsPiLaten(data) {
  return data
    .filter(item => item.INDIKATOR && item.TARGET && item.REAL && item["ACH %"] != null)
    .map(item => {
      const ach = parseFloat(item["ACH %"]) || 0;
      const bobot = parseFloat(item.BOBOT) || 0;
      const status = ach === bobot ? '✅' : '❌';
      return `<tr>
        <td>${item.INDIKATOR}</td>
        <td>${item.TARGET}</td>
        <td>${item.REAL}</td>
        <td>${ach.toFixed(2)}</td>
        <td class="text-center">${status}</td>
      </tr>`;
    }).join("");
}
function loadKpiB2c() {
  showLoading();

  fetch(`${scriptURL}?kategori=dashboard ioan b2c`)
    .then(response => response.json())
    .then(data => {
      hideLoading();
      document.getElementById("headerSection").style.display = "none";

      const container = document.getElementById("dashboardContent");
      container.innerHTML = `
        <div class="container py-3">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5>📊 Dashboard KPI IOAN B2C</h5>
            <button id="btnToggleTables" class="btn btn-secondary btn-sm">Tampilkan Perbandingan Tabel</button>
          </div>
          <div id="kpiB2cContent"></div>
          <div id="perbandinganTables" class="mt-4" style="display:none;"></div>
          <div id="gagalTable" class="mt-4"></div>
        </div>
      `;

      window.kpiB2cData = data;
      renderKpiB2c();

      // Event toggle untuk tabel perbandingan
      document.getElementById("btnToggleTables").addEventListener("click", () => {
        const tableSection = document.getElementById("perbandinganTables");
        if (tableSection.style.display === "none") {
          tableSection.style.display = "block";
          renderPerbandinganTables(data);
          renderTabelGagal(data);
          document.getElementById("btnToggleTables").textContent = "Sembunyikan Perbandingan Tabel";
        } else {
          tableSection.style.display = "none";
          document.getElementById("gagalTable").innerHTML = "";
          document.getElementById("btnToggleTables").textContent = "Tampilkan Perbandingan Tabel";
        }
      });
    })
    .catch(err => {
      hideLoading();
      document.getElementById("dashboardContent").innerHTML =
        '<p class="text-danger text-center">Gagal memuat data KPI B2C.</p>';
      console.error("Error loadKpiB2c:", err);
    });
}

// Fungsi render utama KPI B2C (menggunakan indikator list dan logika pewarnaan)
function renderKpiB2c() {
  const container = document.getElementById("kpiB2cContent");
  const data = window.kpiB2cData || [];

  const indikatorList = [
    "Assurance guarantee All",
    "Service Availability (All Teknis)",
    "Q Gangguan (All Teknis)",
    "TTR COMP - 36JAM (Non HVC)",
    "TTR COMP - 3H HVC (D,V)",
    "TTR COMP - 3H Manja",
    "TTR COMP - 6H (P)",
    "TTR COMP - 12H (Gold)",
    "Tangible ODP (Kuantitas)",
    "Tangible ODP (Kualitas)",
    "Tangible ODC (Kuantitas)",
    "Tangible ODC (Kualitas)",
    "VALINS DC QR Code & Service",
    "VALINS Visit ODP",
    "Validasi ODC",
    "Validasi Connect ODP-OLT",
    "Validasi Tiang",
    "TTR Comply SQM 4H (Exclude tiket AWH)",
    "Unspec Non Warranty",
    "Closed SQM",
    "SCC Inet",
    "SCC Voice",
    "InfraCare - Tiket Close",
    "Rasio INUSE to INSTOCK - Dropcore Refurbish",
  ];

  const cards = indikatorList.map(indikator => {
    let target = 0, realTangerang = 0, realBanten = 0;

    const tgr = data.find(row => row.INDIKATOR === indikator && (row.STO || "").toUpperCase().includes("TANGERANG"));
    const ban = data.find(row => row.INDIKATOR === indikator && (row.STO || "").toUpperCase().includes("BANTEN"));
    target = parseFloat(tgr?.TARGET || ban?.TARGET || 0);
    realTangerang = parseFloat(tgr?.REAL || 0);
    realBanten = parseFloat(ban?.REAL || 0);

    const indikatorKhusus = ["Q GANGGUAN (ALL TEKNIS)", "UNSPEC NON WARRANTY"];
    const isKhusus = indikatorKhusus.includes(indikator.toUpperCase());

    // Penentuan status ✅ atau ❌ berdasarkan logika indikator
    const bantenStatus = isKhusus ? realBanten < target : realBanten >= target;
    const tangerangStatus = isKhusus ? realTangerang < target : realTangerang >= target;

    // Penentuan warna card
    let warna = "bg-green";
    if (bantenStatus && tangerangStatus) warna = "bg-green";
    else if (!bantenStatus && !tangerangStatus) warna = "bg-red";
    else warna = "bg-yellow";

    return `
      <div class="col">
        <div class="card h-100 border-secondary" title="${indikator}">
          <div class="card-header text-center card-header-indikator">
            <strong style="font-size: 0.8rem;">${indikator}</strong>
          </div>
          <div class="card-body text-center p-2 ${warna}">
            <p style="font-size: 0.75rem;">
              <strong>Target:</strong> ${target.toFixed(2)}%<br>
              <span style="color: ${bantenStatus ? 'black' : 'red'};"><strong>Banten:</strong> ${realBanten.toFixed(2)}%</span><br>
              <span style="color: ${tangerangStatus ? 'black' : 'red'};"><strong>Tangerang:</strong> ${realTangerang.toFixed(2)}%</span>
            </p>
          </div>
        </div>
      </div>
    `;
  }).join("");

  container.innerHTML = `
    <div class="row row-cols-2 row-cols-sm-3 row-cols-md-4 row-cols-lg-6 g-3">
        ${cards}
    </div>
  `;
}

// Fungsi helper generate baris tabel dari data di perbandingan
function generateTableRows(data) {
  return data.map(item => {
    const indikator = (item.INDIKATOR || "").trim().toUpperCase();
    const target = parseFloat(item.TARGET) || 0;
    const real = parseFloat(item.REAL) || 0;
    const ach = target > 0 ? (real / target) * 100 : 0;

    // Indikator dengan logika khusus
    const indikatorKhusus = ["Q GANGGUAN (ALL TEKNIS)", "UNSPEC NON WARRANTY"];

    let status = "✅";
    if (indikatorKhusus.includes(indikator)) {
      status = real < target ? "✅" : "❌";
    } else {
      status = ach >= 100 ? "✅" : "❌";
    }

    return `<tr>
      <td>${item.INDIKATOR || ""}</td>
      <td class="text-end">${target.toFixed(2)}</td>
      <td class="text-end">${real.toFixed(2)}</td>
      <td class="text-end">${ach.toFixed(2)}%</td>
      <td class="text-center">${status}</td>
    </tr>`;
  }).join("");
}

// Fungsi render perbandingan tabel sesuai request
function renderPerbandinganTables(data) {
  const witelData = { BANTEN: [], TANGERANG: [] };
  data.forEach(item => {
    const witel = (item.WITEL || "").toUpperCase();
    const sto = (item.STO || "").toUpperCase();
    if (witel.includes("BANTEN") && sto === "BANTEN") {
      witelData.BANTEN.push(item);
    } else if (witel.includes("TANGERANG") && sto === "TANGERANG") {
      witelData.TANGERANG.push(item);
    }
  });

  const tableSection = document.getElementById("perbandinganTables");
  if (!tableSection) return;
  tableSection.innerHTML = `
    <div class="row">
      <div class="col-md-6">
        <h6 class="text-center">WITEL TANGERANG</h6>
        <div class="table-responsive">
          <table class="table table-sm table-bordered align-middle">
            <thead class="table-light text-center">
              <tr><th>INDIKATOR</th><th>TARGET</th><th>REAL</th><th>ACH %</th><th>STATUS</th></tr>
            </thead>
            <tbody>
              ${generateTableRows(witelData.TANGERANG)}
            </tbody>
          </table>
        </div>
      </div>
      <div class="col-md-6">
        <h6 class="text-center">WITEL BANTEN</h6>
        <div class="table-responsive">
          <table class="table table-sm table-bordered align-middle">
            <thead class="table-light text-center">
              <tr><th>INDIKATOR</th><th>TARGET</th><th>REAL</th><th>ACH %</th><th>STATUS</th></tr>
            </thead>
            <tbody>
              ${generateTableRows(witelData.BANTEN)}
            </tbody>
          </table>
        </div>
      </div>
    </div>`;
}

// Fungsi render tabel gagal (indikator dengan status ❌)
function renderTabelGagal(data) {
  const groupedByWitel = {};

  data.forEach(item => {
    const ach = parseFloat(item["ACH %"]) || 0;
    const bobot = parseFloat(item.BOBOT) || 0;
    const indikator = (item.INDIKATOR || "").trim().toUpperCase();
    const sto = (item.STO || "").trim().toUpperCase();
    const hsa = (item.HSA || "").trim().toUpperCase();
    const witel = (item.WITEL || "").trim().toUpperCase();

    // Saring data yang tidak diperlukan
    if (
      indikator === "TOTAL ACH" ||
      sto === "TANGERANG" || sto === "BANTEN" ||
      ach === bobot
    ) return;

    if (!groupedByWitel[witel]) {
      groupedByWitel[witel] = {};
    }

    const key = `${indikator}|${hsa}`;
    if (!groupedByWitel[witel][key]) {
      groupedByWitel[witel][key] = { indikator, hsa, stos: [] };
    }

    if (!groupedByWitel[witel][key].stos.includes(sto)) {
      groupedByWitel[witel][key].stos.push(sto);
    }
  });

  const gagalDiv = document.getElementById("gagalTable");
  if (!gagalDiv) return;

  // Bangun tabel HTML per WITEL
  let html = `<h6 class="text-center text-danger">Indikator dengan Status ❌</h6>`;

  Object.keys(groupedByWitel).sort().forEach(witel => {
    const rows = Object.values(groupedByWitel[witel]).sort((a, b) =>
      a.indikator.localeCompare(b.indikator)
    );

    html += `
      <h6 class="mt-4 text-primary">WITEL ${witel}</h6>
      <div class="table-responsive">
        <table class="table table-sm table-bordered align-middle">
          <thead class="table-danger text-center">
            <tr>
              <th>INDIKATOR</th>
              <th>STO</th>
              <th>HSA</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(row => `
              <tr>
                <td>${row.indikator}</td>
                <td>${row.stos.join(", ")}</td>
                <td>${row.hsa}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      </div>`;
  });

  gagalDiv.innerHTML = html;
}
function loadServiceAvailability() {
  showLoading();
  document.getElementById('headerSection').style.display = 'none'; // Sembunyikan welcome saat loading

  fetch(`${scriptURL}?kategori=service availability`)
    .then(response => {
      if(!response.ok) throw new Error("Network response was not ok");
      return response.json();
    })
    .then(data => {
      hideLoading();

      if (!data.summary || data.summary.length === 0) {
        document.getElementById("dashboardContent").innerHTML = '<p class="text-center text-danger">Data summary tidak tersedia.</p>';
        return;
      }

      // Filter wilayah Banten dan Tangerang untuk card
      let filteredSummary = data.summary.filter(item =>
        item.wilayah.toUpperCase() === 'BANTEN' || item.wilayah.toUpperCase() === 'TANGERANG'
      );

      let htmlCards = '<div class="row justify-content-center">';
      filteredSummary.forEach(item => {
        const nilai = item.nilai ?? 0;
        const target = item.target ?? 98.52; // Gunakan nilai target dari data asli
        const nilaiClass = nilai < target ? 'text-danger fw-bold' : 'text-success fw-bold';

        htmlCards += `
          <div class="card m-2" style="width: 18rem;">
            <div class="card-body text-center">
              <h5 class="card-title">${item.wilayah}</h5>
              <p>Nilai: <span class="${nilaiClass}">${nilai.toFixed(2)}%</span></p>
              <p>Target: ${target.toFixed(2)}%</p>
              <p>Bulan: ${item.bulan}</p>
              <p>Rata-rata (AVG): ${item.avg !== null ? item.avg.toFixed(2) + '%' : '-'}</p>
            </div>
          </div>
        `;
      });
      htmlCards += '</div>';

      // Tabel dengan pewarnaan sesuai target di setiap baris
      let tableHtml = `
        <div class="table-responsive mt-4">
          <table class="table table-bordered table-striped table-hover table-sm w-auto" style="font-size: 0.8rem;">
            <thead>
              <tr>
                ${data.tabel[0].map(th => `<th>${th}</th>`).join('')}
              </tr>
            </thead>
            <tbody>
              ${data.tabel.slice(1).map(row => {
                const target = parseFloat(row[1]) || 0;
                return `
                  <tr>
                    ${row.map((td, idx) => {
                      if (idx > 1 && idx < row.length) {
                        const nilai = parseFloat(td);
                        if (nilai < target) {
                          return `<td class="text-danger">${td}</td>`;
                        }
                      }
                      return `<td>${td}</td>`;
                    }).join('')}
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      `;

      document.getElementById('dashboardContent').innerHTML = `
        <h5 class="mb-4 text-center">📊 KPI IOAN - Service Availability</h5>
        ${htmlCards}
        <hr/>
        <h5 class="mt-4">Tabel Service Availability Seluruh Wilayah</h5>
        ${tableHtml}
      `;
    })
    .catch(error => {
      hideLoading();
      console.error("Fetch error:", error);
      document.getElementById('dashboardContent').innerHTML = '<p class="text-center text-danger">Gagal memuat data Service Availability.</p>';
    });
}

function loadSummaryTiket() {
  showLoading();
  document.getElementById('headerSection').style.display = 'none'; 
  fetch("https://script.google.com/macros/s/AKfycbwq85CIdDt06BPp4CayvtOwsjNcTuIAzzsfljN4gEa1m7PA74KbBC9RMmMk-ifltgf0/exec?kategori=summary tiket b2c")
    .then(res => res.json())
    .then(data => {
      hideLoading();
      renderPivotSummary(data);
    })
    .catch(err => {
      hideLoading();
      alert("❌ Gagal ambil data: " + err.message);
    });
}

function renderPivotSummary(data) {
  const container = document.getElementById("dashboardContent");
  const mainHeaderStyle = 'background-color:#000000;color:#FFFFFF;text-align:center;';
  const ttrHeaderStyles = [
    'background-color:#c6efce;color:#006100;',
    'background-color:#c6efce;color:#006100;',
    'background-color:#c6efce;color:#006100;',
    'background-color:#ffc7ce;color:#9c0006;',
  ];
  const ttrMainHeaderWithBorder = 'background-color:#000000;color:#FFFFFF;border:2px solid red;text-align:center;';

  let htmlTangerang = `
    <h5 class='mb-3'>📊 Summary KPI TIKET B2C - WITEL TANGERANG (Full SLA Breakdown)</h5>
    <div class='table-responsive'>
    <table class='table table-bordered table-sm text-center align-middle'>
      <thead>
        <tr style="${mainHeaderStyle}">
          <th rowspan="2">STO</th>
          <th rowspan="2">Q GANGGUAN</th>
          <th rowspan="2">Q HVC</th>
          <th rowspan="2">ASGAR ALL</th>
          <th rowspan="2">ASGAR HVC</th>
          <th colspan="4" style="${ttrMainHeaderWithBorder}">TTR 3 JAM HVC</th>
          <th colspan="4" style="${ttrMainHeaderWithBorder}">TTR 6 JAM PLATINUM</th>
          <th colspan="4" style="${ttrMainHeaderWithBorder}">TTR 3 JAM MANJA</th>
          <th colspan="4" style="${ttrMainHeaderWithBorder}">TTR 12 JAM GOLD</th>
          <th colspan="4" style="${ttrMainHeaderWithBorder}">TTR 36 JAM</th>
        </tr>
        <tr>
          <th style="${ttrHeaderStyles[0]}"><1 JAM</th>
          <th style="${ttrHeaderStyles[1]}"><2 JAM</th>
          <th style="${ttrHeaderStyles[2]}"><3 JAM</th>
          <th style="${ttrHeaderStyles[3]}">>3 JAM</th>

          <th style="${ttrHeaderStyles[0]}"><1 JAM</th>
          <th style="${ttrHeaderStyles[1]}"><3 JAM</th>
          <th style="${ttrHeaderStyles[2]}"><6 JAM</th>
          <th style="${ttrHeaderStyles[3]}">>6 JAM</th>

          <th style="${ttrHeaderStyles[0]}"><1 JAM</th>
          <th style="${ttrHeaderStyles[1]}"><2 JAM</th>
          <th style="${ttrHeaderStyles[2]}"><3 JAM</th>
          <th style="${ttrHeaderStyles[3]}">>3 JAM</th>

          <th style="${ttrHeaderStyles[0]}"><4 JAM</th>
          <th style="${ttrHeaderStyles[1]}"><8 JAM</th>
          <th style="${ttrHeaderStyles[2]}"><12 JAM</th>
          <th style="${ttrHeaderStyles[3]}">>12 JAM</th>

          <th style="${ttrHeaderStyles[0]}"><12 JAM</th>
          <th style="${ttrHeaderStyles[1]}"><24 JAM</th>
          <th style="${ttrHeaderStyles[2]}"><36 JAM</th>
          <th style="${ttrHeaderStyles[3]}">>36 JAM</th>
        </tr>
      </thead>
      <tbody>
  `;

  let htmlBanten = `
    <h5 class='mb-3'>📊 Summary KPI TIKET B2C - WITEL BANTEN (Full SLA Breakdown)</h5>
    <div class='table-responsive'>
    <table class='table table-bordered table-sm text-center align-middle'>
      <thead>
        <tr style="${mainHeaderStyle}">
          <th rowspan="2">STO</th>
          <th rowspan="2">Q GANGGUAN</th>
          <th rowspan="2">Q HVC</th>
          <th rowspan="2">ASGAR ALL</th>
          <th rowspan="2">ASGAR HVC</th>
          <th colspan="4" style="${ttrMainHeaderWithBorder}">TTR 3 JAM HVC</th>
          <th colspan="4" style="${ttrMainHeaderWithBorder}">TTR 6 JAM PLATINUM</th>
          <th colspan="4" style="${ttrMainHeaderWithBorder}">TTR 3 JAM MANJA</th>
          <th colspan="4" style="${ttrMainHeaderWithBorder}">TTR 12 JAM GOLD</th>
          <th colspan="4" style="${ttrMainHeaderWithBorder}">TTR 36 JAM</th>
        </tr>
        <tr>
          <th style="${ttrHeaderStyles[0]}"><1 JAM</th>
          <th style="${ttrHeaderStyles[1]}"><2 JAM</th>
          <th style="${ttrHeaderStyles[2]}"><3 JAM</th>
          <th style="${ttrHeaderStyles[3]}">>3 JAM</th>

          <th style="${ttrHeaderStyles[0]}"><1 JAM</th>
          <th style="${ttrHeaderStyles[1]}"><3 JAM</th>
          <th style="${ttrHeaderStyles[2]}"><6 JAM</th>
          <th style="${ttrHeaderStyles[3]}">>6 JAM</th>

          <th style="${ttrHeaderStyles[0]}"><1 JAM</th>
          <th style="${ttrHeaderStyles[1]}"><2 JAM</th>
          <th style="${ttrHeaderStyles[2]}"><3 JAM</th>
          <th style="${ttrHeaderStyles[3]}">>3 JAM</th>

          <th style="${ttrHeaderStyles[0]}"><4 JAM</th>
          <th style="${ttrHeaderStyles[1]}"><8 JAM</th>
          <th style="${ttrHeaderStyles[2]}"><12 JAM</th>
          <th style="${ttrHeaderStyles[3]}">>12 JAM</th>

          <th style="${ttrHeaderStyles[0]}"><12 JAM</th>
          <th style="${ttrHeaderStyles[1]}"><24 JAM</th>
          <th style="${ttrHeaderStyles[2]}"><36 JAM</th>
          <th style="${ttrHeaderStyles[3]}">>36 JAM</th>
        </tr>
      </thead>
      <tbody>
  `;

  const renderCellWithColor = (value) => {
    if (typeof value === 'number' && value > 0) {
      return `<td style="background-color:#ffc7ce;color:#9c0006;font-weight:bold;">${value}</td>`;
    } else {
      return `<td>${value ?? 0}</td>`;
    }
  };

  data.forEach(row => {
    const d = row.ttr_d_vvip || [0, 0, 0, 0];
    const p = row.ttr_platinum || [0, 0, 0, 0];
    const m = row.ttr_manja || [0, 0, 0, 0];
    const g = row.ttr_gold || [0, 0, 0, 0];
    const s = row.ttr_36jam || [0, 0, 0, 0];

    const rowHtml = `
      <tr>
        <td>${row.sto}</td>
        <td>${row.q_all ?? 0}</td>
        <td>${row.q_hvc ?? 0}</td>
        <td>${row.asgar_all ?? 0}</td>
        <td>${row.asgar_hvc ?? 0}</td>

        ${d.map(renderCellWithColor).join('')}
        ${p.map(renderCellWithColor).join('')}
        ${m.map(renderCellWithColor).join('')}
        ${g.map(renderCellWithColor).join('')}
        ${s.map(renderCellWithColor).join('')}
      </tr>
    `;

    if (row.witel && row.witel.toUpperCase() === 'TANGERANG') {
      htmlTangerang += rowHtml;
    } else if (row.witel && row.witel.toUpperCase() === 'BANTEN') {
      htmlBanten += rowHtml;
    }
  });

  htmlTangerang += `</tbody></table></div>`;
  htmlBanten += `</tbody></table></div>`;

  container.innerHTML = htmlTangerang + htmlBanten;
}

function showDetail(witel, sto, slaType, rangeIndex) {
  const url = "https://script.google.com/macros/s/AKfycbwq85CIdDt06BPp4CayvtOwsjNcTuIAzzsfljN4gEa1m7PA74KbBC9RMmMk-ifltgf0/exec?kategori=tiket b2c";

  fetch(url)
    .then(res => res.json())
    .then(data => {
      const headers = data[0];
      const rows = data.slice(1);
      const result = [];

      const idxIncident = 0;
      const idxSummary = 2;
      const idxWorkzone = 9;
      const idxStatus = 6;
      const idxCustomerType = 24;
      const idxSymptom = 4;
      const idxReported = 3;
      const idxBooking = 17;
      const idxWitel = 8;
      const idxGaul = 80;
      const idxHvc = 81;
      const idxManja = 96;

      const now = new Date();

      rows.forEach(row => {
        const rwitel = (row[idxWitel] || "").toString().toUpperCase();
        const rsto = (row[idxWorkzone] || "").toString().toUpperCase();
        const customerType = (row[idxCustomerType] || "").toString().toUpperCase();
        const hvc = (row[idxHvc] || "").toString().toUpperCase();
        const manja = (row[idxManja] || "").toString().toUpperCase();
        const reported = new Date(row[idxReported]);
        const booking = new Date(row[idxBooking]);

        if (rwitel !== witel || rsto !== sto) return;

        const diff = Math.floor((now - (slaType === 'MANJA' ? booking : reported)) / 60000);
        let match = false;

        if (slaType === "TTR_3_HVC" && ["DIAMOND", "VVIP"].includes(customerType)) {
          if ((rangeIndex === 0 && diff < 60) ||
              (rangeIndex === 1 && diff >= 60 && diff < 120) ||
              (rangeIndex === 2 && diff >= 120 && diff < 180) ||
              (rangeIndex === 3 && diff >= 180)) {
            match = true;
          }
        }

        if (slaType === "TTR_6_PLATINUM" && customerType === "PLATINUM") {
          if ((rangeIndex === 0 && diff < 60) ||
              (rangeIndex === 1 && diff >= 60 && diff < 180) ||
              (rangeIndex === 2 && diff >= 180 && diff < 360) ||
              (rangeIndex === 3 && diff >= 360)) {
            match = true;
          }
        }

        if (slaType === "TTR_3_MANJA" && manja === "Y") {
          if ((rangeIndex === 0 && diff < 60) ||
              (rangeIndex === 1 && diff >= 60 && diff < 120) ||
              (rangeIndex === 2 && diff >= 120 && diff < 180) ||
              (rangeIndex === 3 && diff >= 180)) {
            match = true;
          }
        }

        if (slaType === "TTR_12_GOLD" && customerType === "GOLD") {
          if ((rangeIndex === 0 && diff < 240) ||
              (rangeIndex === 1 && diff >= 240 && diff < 480) ||
              (rangeIndex === 2 && diff >= 480 && diff < 720) ||
              (rangeIndex === 3 && diff >= 720)) {
            match = true;
          }
        }

        if (slaType === "TTR_36" && true) {
          if ((rangeIndex === 0 && diff < 720) ||
              (rangeIndex === 1 && diff >= 720 && diff < 1440) ||
              (rangeIndex === 2 && diff >= 1440 && diff < 2160) ||
              (rangeIndex === 3 && diff >= 2160)) {
            match = true;
          }
        }

        if (match) {
          result.push([
            row[idxIncident], row[idxSummary], row[idxWorkzone],
            row[idxStatus], row[idxCustomerType], row[idxSymptom]
          ]);
        }
      });

      // Tampilkan hasil
      let html = `<h5>Detail ${slaType.replaceAll('_', ' ')} (${witel} - ${sto})</h5>`;
      if (result.length === 0) {
        html += `<div class="alert alert-warning">Data tidak ditemukan.</div>`;
      } else {
        html += `<div class="table-responsive"><table class="table table-bordered table-sm text-center">
          <thead class="table-secondary"><tr>
          <th>INCIDENT</th><th>SUMMARY</th><th>WORKZONE</th><th>STATUS</th><th>CUSTOMER TYPE</th><th>SYMPTOM</th>
          </tr></thead><tbody>`;
        result.forEach(r => {
          html += `<tr>${r.map(c => `<td>${c}</td>`).join('')}</tr>`;
        });
        html += `</tbody></table></div>`;
      }

      // Masukkan ke modal atau popup
      const modal = document.createElement('div');
      modal.className = "modal fade";
      modal.innerHTML = `
        <div class="modal-dialog modal-xl modal-dialog-scrollable"><div class="modal-content">
          <div class="modal-header"><h5 class="modal-title">Detail TTR</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">${html}</div>
        </div></div>
      `;
      document.body.appendChild(modal);
      const bsModal = new bootstrap.Modal(modal);
      bsModal.show();

      modal.addEventListener('hidden.bs.modal', () => modal.remove());
    });
}
function loadPiLaten12() {
  showLoading();
  document.getElementById("headerSection").style.display = "none";
  const container = document.getElementById("dashboardContent");

  Promise.all([
    fetch(`${scriptURL}?kategori=12 pi laten`).then(res => res.json()),
    fetch(`${scriptURL}?kategori=dashboard ioan b2c`).then(res => res.json())
  ])
    .then(([piLatenData, kpiB2cData]) => {
      hideLoading();
      const htmlPiLaten = renderPiLatenDashboard(piLatenData);
      const htmlKpiB2c = renderKpiB2cDashboard(kpiB2cData);
      container.innerHTML = htmlPiLaten + '<hr class="my-5">' + htmlKpiB2c;
    })
    .catch(err => {
      hideLoading();
      container.innerHTML = `<p class='text-danger text-center'>Gagal memuat data: ${err.message}</p>`;
    });
}

function renderPiLatenDashboard(data) {
  function getStoData(sto) {
    return data.filter(item =>
      (item.STO || "").toUpperCase() === sto.toUpperCase() &&
      item.INDIKATOR !== "TOTAL ACH"
    );
  }

  function hitungLulus(stoData) {
    return stoData.filter(item => parseFloat(item["ACH %"]) === 1).length;
  }

  function hitungGagal(stoData) {
    return stoData.filter(item => parseFloat(item["ACH %"]) === 0).length;
  }

  function getGagalIndikator(stoData) {
    return stoData.filter(item => parseFloat(item["ACH %"]) === 0).map(item => {
      const target = parseFloat(item.TARGET) || 0;
      const h1 = parseFloat(item["REAL H-1"]) || 0;
      const h2 = parseFloat(item.REAL) || 0;
      const growth = h2 - h1;
      let icon = "→";
      if (growth > 0.01) icon = "↑";
      else if (growth < -0.01) icon = "↓";
      return `
        <tr>
          <td>${item.INDIKATOR}</td>
          <td class="text-danger fw-bold">${target.toFixed(2)}</td>
          <td>${h1.toFixed(2)}</td>
          <td class="text-center">${icon}</td>
          <td>${h2.toFixed(2)}</td>
        </tr>`;
    }).join("");
  }

  function getRankingTabel(title, list) {
    return `
      <div class="col-md-6">
        <div class="card border-0 shadow rounded-4 h-100 animate__animated animate__fadeIn" style="background: linear-gradient(135deg, #f9f9f9, #ffffff);">
          <div class="card-header bg-dark text-white text-center fw-bold rounded-top-4">${title}</div>
          <div class="card-body p-3">
            <table class="table table-sm table-hover table-bordered align-middle text-center rounded-3 overflow-hidden">
              <thead class="table-dark">
                <tr><th>#</th><th>HSA/STO</th><th>ACH %</th></tr>
              </thead>
              <tbody>
                ${list.map((item, idx) => `
                  <tr>
                    <td>${idx + 1}</td>
                    <td class="fw-semibold">${item.hsa || (item.STO + ' (' + item.HSA + ')')}</td>
                    <td class="fw-bold ${item.total >= 0.95 ? 'text-success' : 'text-danger'}">
                      ${(item.total).toFixed(0)}
                    </td>
                  </tr>`).join("")}
              </tbody>
            </table>
          </div>
        </div>
      </div>`;
  }

  function getHsaRanking(type = "best") {
    const hsaTotal = {};
    data.forEach(item => {
      const hsa = item.HSA || "";
      const ach = parseFloat(item["ACH %"]) || 0;
      if (item.INDIKATOR === "TOTAL ACH" && hsa !== "AMIN") {
        hsaTotal[hsa] = ach;
      }
    });
    const hasil = Object.entries(hsaTotal).map(([hsa, total]) => ({ hsa, total }));
    return hasil
      .sort((a, b) => type === "best" ? b.total - a.total : a.total - b.total)
      .slice(0, 3);
  }

  function getStoRanking() {
    return data
      .filter(item =>
        item.INDIKATOR === "TOTAL ACH" &&
        item.STO &&
        item.HSA &&
        item.STO !== "TANGERANG" &&
        item.STO !== "BANTEN"
      )
      .sort((a, b) => parseFloat(b["ACH %"]) - parseFloat(a["ACH %"]))
      .slice(0, 5)
      .map(item => ({
        hsa: item.STO + ' (' + item.HSA + ')',
        total: parseFloat(item["ACH %"])
      }));
  }

  const tgrData = getStoData("TANGERANG");
  const banData = getStoData("BANTEN");
  const bestHsa = getHsaRanking("best");
  const worstHsa = getHsaRanking("worst");
  const topSto = getStoRanking();

  return `
    <div class="row g-4 mb-4">
      ${["TANGERANG", "BANTEN"].map(sto => {
        const stoData = getStoData(sto);
        const totalLulus = hitungLulus(stoData);
        const badgeClass = totalLulus >= 12 ? 'bg-gradient bg-primary' : 'bg-warning text-dark';
        const labelClass = totalLulus >= 12 ? 'PLATINUM' : 'GOLD';
        return `
        <div class="col-md-6">
          <div class="card border-0 shadow-lg rounded-4 animate__animated animate__fadeInUp">
            <div class="card-header text-white text-center fw-bold ${badgeClass} rounded-top-4">12 PI LATEN - STO ${sto}</div>
            <div class="card-body p-3 bg-light rounded-bottom-4">
              <div class="d-flex justify-content-around mb-3">
                <span class="badge bg-success px-3 py-2 fs-6 shadow-sm">✅ LULUS: ${totalLulus}</span>
                <span class="badge bg-danger px-3 py-2 fs-6 shadow-sm">❌ GAGAL: ${hitungGagal(stoData)}</span>
                <span class="badge ${badgeClass} px-3 py-2 fs-6 shadow-sm">🏅 ${labelClass}</span>
              </div>
              <div class="table-responsive">
                <table class="table table-sm table-striped table-hover text-center align-middle rounded-3 overflow-hidden">
                  <thead class="table-dark">
                    <tr><th>Indikator</th><th>Target</th><th>H-1</th><th>Δ</th><th>H</th></tr>
                  </thead>
                  <tbody>${getGagalIndikator(stoData)}</tbody>
                </table>
              </div>
            </div>
          </div>
        </div>`;
      }).join("")}
    </div>

    <div class="row g-4">
      ${getRankingTabel("Top 3 HSA with Best ACH", bestHsa)}
      ${getRankingTabel("Top 3 HSA with Worst ACH", worstHsa)}
    </div>

    <div class="row mt-4">
      ${getRankingTabel("Top 5 STO with Best ACH", topSto)}
    </div>
  `;
}

function renderKpiB2cDashboard(data) {
  function getStoData(sto) {
    return data.filter(item =>
      (item.STO || "").toUpperCase() === sto.toUpperCase() &&
      item.INDIKATOR !== "TOTAL ACH B2C"
    );
  }

  function isExceptionIndikator(nama) {
    return ["Q Gangguan (All Teknis)", "Unspec Non Warranty"].includes(nama.trim());
  }

  function hitungLulus(stoData) {
    return stoData.filter(item => {
      const real = parseFloat(item.REAL) || 0;
      const target = parseFloat(item.TARGET) || 0;
      const indikator = item.INDIKATOR || "";
      return isExceptionIndikator(indikator) ? real < target : real > target;
    }).length;
  }

  function hitungGagal(stoData) {
    return stoData.filter(item => {
      const real = parseFloat(item.REAL) || 0;
      const target = parseFloat(item.TARGET) || 0;
      const indikator = item.INDIKATOR || "";
      return isExceptionIndikator(indikator) ? real > target : real < target;
    }).length;
  }

  function getGagalIndikator(stoData) {
    return stoData.filter(item => {
      const real = parseFloat(item.REAL) || 0;
      const target = parseFloat(item.TARGET) || 0;
      const indikator = item.INDIKATOR || "";
      return isExceptionIndikator(indikator) ? real > target : real < target;
    }).map(item => {
      const target = parseFloat(item.TARGET) || 0;
      const h1 = parseFloat(item["REAL H-1"]) || 0;
      const h2 = parseFloat(item.REAL) || 0;
      const growth = h2 - h1;
      let icon = "⇨";
      let color = "text-secondary";
      if (growth > 0.1) icon = "⬆️", color = "text-success";
      else if (growth < -0.1) icon = "⬇️", color = "text-danger";
      return `
        <tr>
          <td class="text-start">${item.INDIKATOR}</td>
          <td><span class="badge bg-danger">${target.toFixed(1)}</span></td>
          <td>${h1.toFixed(1)}</td>
          <td class="${color} fs-5">${icon}</td>
          <td>${h2.toFixed(1)}</td>
        </tr>`;
    }).join("");
  }

  function getHsaRanking() {
  const hsaData = data.filter(item =>
    item.INDIKATOR === "TOTAL ACH B2C" && item.HSA && item.STO && item.HSA.toUpperCase() !== "AMIN"
  );

  return hsaData
    .sort((a, b) => parseFloat(a.REAL) - parseFloat(b.REAL)) // dari rendah ke tinggi
    .slice(0, 10)
    .map(item => `
      <tr>
        <td>${item.STO}</td>
        <td>${item.HSA}</td>
        <td class="${item.REAL < 70 ? 'text-danger' : 'text-success'} fw-bold">${parseFloat(item.REAL).toFixed(2)}%</td>
        <td class="fs-5">☠️</td>
      </tr>
    `).join("");
}

function getBestHsaRanking() {
  const hsaData = data.filter(item =>
    item.INDIKATOR === "TOTAL ACH B2C" && item.HSA && item.STO && item.HSA.toUpperCase() !== "AMIN"
  );

  const sorted = hsaData
    .sort((a, b) => parseFloat(b.REAL) - parseFloat(a.REAL)) // dari tinggi ke rendah
    .slice(0, 10);

  const max = sorted[0]?.REAL || 0;
  const min = sorted[sorted.length - 1]?.REAL || 0;

  return {
    list: sorted.map(item => `
      <tr>
        <td>${item.STO}</td>
        <td>${item.HSA}</td>
        <td class="${item.REAL < 70 ? 'text-danger' : 'text-success'} fw-bold">${parseFloat(item.REAL).toFixed(2)}%</td>
        <td class="fs-5">🏅</td>
      </tr>
    `).join(""),
    max,
    min
  };
}

  function getStoRanking() {
    return data.filter(item => item.INDIKATOR === "TOTAL ACH B2C" && item.STO && item.HSA)
      .sort((a, b) => parseFloat(b.REAL) - parseFloat(a.REAL))
      .slice(0, 5)
      .map(item => `
        <tr>
          <td>${item.STO}</td>
          <td>${item.HSA}</td>
          <td class="fw-bold">${parseFloat(item.REAL).toFixed(1)}%</td>
        </tr>`).join("");
  }

  function renderStoCard(sto, color) {
    const dataSto = getStoData(sto);
    const lulus = hitungLulus(dataSto);
    const gagal = hitungGagal(dataSto);
    const total = lulus + gagal;
    const percent = total > 0 ? (lulus / total) * 100 : 0;

    return `
      <div class="col-md-6">
        <div class="card border-0 shadow-sm">
          <div class="card-header text-white fw-bold text-center" style="background: ${color}; border-radius: .5rem .5rem 0 0;">
            KPI IOAN B2C - STO ${sto.toUpperCase()}
          </div>
          <div class="card-body">
            <div class="mb-3">
              <div class="d-flex justify-content-between small">
                <span class="text-muted">LULUS: ${lulus} Indikator</span>
                <span class="text-muted">TOTAL: ${total}</span>
              </div>
              <div class="progress rounded-pill" style="height: 12px;">
                <div class="progress-bar bg-success" style="width: ${percent.toFixed(1)}%"></div>
              </div>
            </div>
            <table class="table table-hover table-sm align-middle text-center">
              <thead class="table-light">
                <tr><th>Indikator</th><th>Target</th><th>H-1</th><th>Δ</th><th>H</th></tr>
              </thead>
              <tbody>${getGagalIndikator(dataSto)}</tbody>
            </table>
          </div>
        </div>
      </div>`;
  }

  return `
    <div class="row g-4">
      ${renderStoCard("TANGERANG", "linear-gradient(45deg, #007bff, #00c6ff)")}
      ${renderStoCard("BANTEN", "linear-gradient(45deg, #dc3545, #ff6f61)")}
    </div>

    <div class="row my-5 g-4">
      <div class="col-md-6">
        <div class="card shadow-sm border-0 h-100">
          <div class="card-header bg-dark text-white text-center fw-bold rounded-top">☠️ Worst Ranking HSA KPI IOAN B2C</div>
          <div class="card-body">
            <table class="table table-sm table-borderless text-center align-middle">
              <thead class="table-secondary">
                <tr><th>STO</th><th>HSA</th><th>ACH (%)</th><th>☠️</th></tr>
              </thead>
              <tbody>${getHsaRanking()}</tbody>
            </table>
          </div>
        </div>
      </div>

      ${(() => {
        const best = getBestHsaRanking();
        return `
        <div class="col-md-6">
          <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-primary text-white text-center fw-bold rounded-top">🏆 Best Ranking HSA KPI IOAN B2C</div>
            <div class="card-body">
              <table class="table table-sm table-borderless text-center align-middle">
                <thead class="table-secondary">
                  <tr><th>STO</th><th>HSA</th><th>ACH (%)</th><th>🏅</th></tr>
                </thead>
                <tbody>${best.list}</tbody>
              </table>
              <hr>
              <div class="text-center">
                <p class="fs-5 mb-1 fw-semibold">Selisih ACH% Tertinggi - Terendah</p>
                <h3 class="text-success fw-bold">${(best.max - best.min).toFixed(2)}%</h3>
                <p class="text-muted small">(${best.max.toFixed(2)}% - ${best.min.toFixed(2)}%)</p>
              </div>
            </div>
          </div>
        </div>`;
      })()}
    </div>

    <div class="row mb-5">
      <div class="col-md-8 mx-auto">
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-success text-white text-center fw-bold rounded-top">⭐ Top STO KPI IOAN B2C</div>
          <div class="card-body">
            <table class="table table-sm table-striped text-center align-middle">
              <thead class="table-light">
                <tr><th>STO</th><th>HSA</th><th>ACH (%)</th></tr>
              </thead>
              <tbody>${getStoRanking()}</tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  `;
}



function loadAsgarIoan() {
  showLoading();
  document.getElementById("headerSection").style.display = "none";
  fetch(`${scriptURL}?kategori=asgar ioan`)
    .then(response => response.json())
    .then(data => {
      hideLoading();
      document.getElementById("dashboardContent").innerHTML = renderAsgarIoan(data);
    })
    .catch(err => {
      hideLoading();
      document.getElementById("dashboardContent").innerHTML = `<p class='text-danger text-center'>Gagal memuat data: ${err.message}</p>`;
    });
}

function renderAsgarIoan(data) {
  console.log("ASGAR IOAN DATA:", data);
  if (!Array.isArray(data) || data.length === 0 || typeof data[0] !== "object") {
    return "<p class='text-center text-danger'>Tidak ada data tersedia atau format tidak sesuai.</p>";
  }

  const headers = Object.keys(data[0]);
  const headerRow = headers.map(h => `<th class="text-white bg-primary text-center">${h}</th>`).join("");

  const rows = data.map(row => {
    const isEmpty = headers.every(h => row[h] === "" || row[h] === null || row[h] === undefined);
    const target = parseFloat(row["Target"]) || 0;

    const cells = headers.map(h => {
      const val = row[h];
      let cellClass = "text-center";

      if (h !== "Territory" && h !== "Target") {
        const num = parseFloat(val);
        if (!isNaN(num) && num < target) {
          cellClass += " bg-danger text-white";
        }
      }

      return `<td class="${cellClass}">${val !== undefined ? val : ""}</td>`;
    }).join("");

    const rowStyle = isEmpty ? ' style="background-color:#f2f2f2;"' : "";
    return `<tr${rowStyle}>${cells}</tr>`;
  }).join("");

  return `
    <div class="container mt-4">
      <h4 class="text-center mb-4">📊 Assurance Guarantee - ASGAR IOAN</h4>
      <div class="table-responsive">
        <table class="table table-bordered table-sm table-hover text-center">
          <thead><tr>${headerRow}</tr></thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    </div>`;
}
function loadTtrIoan() {
  showLoading();
  document.getElementById("headerSection").style.display = "none";

  fetch(`${scriptURL}?kategori=ttr`)
    .then(res => res.json())
    .then(data => {
      hideLoading();
      const container = document.getElementById("dashboardContent");

      if (!data.length) {
        container.innerHTML = '<p class="text-center text-muted">Tidak ada data TTR ditemukan.</p>';
        return;
      }

      let html = `<h4 class="text-center mb-4 fw-bold">📊 KPI TTR BULANAN</h4>`;

      data.forEach(block => {
        html += `<h5 class="mt-4 fw-semibold text-primary">${block.title}</h5>`;

        // Tabel WITEL
        if (block.witel && block.witel.rows.length > 0) {
          html += `<p class="fw-semibold mt-2 mb-1">WITEL</p>`;
          html += renderTtrTable(block.witel.headers, block.witel.rows);
        }

        // Tabel STO
        if (block.sto && block.sto.rows.length > 0) {
          html += `<p class="fw-semibold mt-4 mb-1">STO</p>`;
          html += renderTtrTable(block.sto.headers, block.sto.rows);
        }
      });

      container.innerHTML = html;
    })
    .catch(err => {
      hideLoading();
      console.error("Gagal muat TTR:", err);
      document.getElementById("dashboardContent").innerHTML =
        '<p class="text-center text-danger">Gagal memuat data TTR.</p>';
    });
}


function renderTtrTable(headers, rows) {
  let html = `<div class="table-responsive"><table class="table table-bordered table-sm text-center align-middle">
    <thead class="table-dark"><tr>`;

  headers.forEach(h => html += `<th>${h}</th>`);
  html += `</tr></thead><tbody>`;

  rows.forEach(row => {
    const isTotal = (row[0] || "").toString().toUpperCase() === "TOTAL";
    const target = parseFloat(row[1]);

    html += `<tr${isTotal ? ' class="fw-bold bg-light"' : ''}>`;

    row.forEach((cell, idx) => {
      let cellClass = "";

      if (idx > 1) { // kolom bulan (bukan Territory / Target)
        const num = parseFloat(cell);
        if (!isNaN(num) && !isNaN(target) && num < target) {
          cellClass = 'bg-danger text-white';
        }
      }

      html += `<td class="${cellClass}">${cell !== undefined && cell !== null ? cell : "-"}</td>`;
    });

    html += `</tr>`;
  });

  html += `</tbody></table></div>`;
  return html;
}
function loadUnderspec() {
  showLoading();
  document.getElementById("headerSection").style.display = "none";

  fetch(`${scriptURL}?kategori=underspec`)
    .then(res => res.json())
    .then(data => {
      hideLoading();
      const { headers, tangerang, banten } = data;
      const container = document.getElementById("dashboardContent");

      let html = `<h4 class="text-center mb-4 fw-bold">📊 DATA UNDERSPEC</h4>`;

      html += `<h5 class="mt-4 text-primary fw-semibold">WITEL TANGERANG</h5>`;
      html += renderUnderspecTable(headers, tangerang);

      html += `<h5 class="mt-4 text-primary fw-semibold">WITEL BANTEN</h5>`;
      html += renderUnderspecTable(headers, banten);

      container.innerHTML = html;
    })
    .catch(err => {
      hideLoading();
      console.error("Gagal memuat data:", err);
      document.getElementById("dashboardContent").innerHTML =
        '<p class="text-center text-danger">Gagal memuat data.</p>';
    });
}
function renderUnderspecTable(headers, rows) {
  let html = `<div class="table-responsive">
    <table class="table table-bordered table-sm text-center align-middle">
      <thead><tr>`;

  headers.forEach(h => {
    html += `<th style="background-color: #000; color: #fff;">${h}</th>`;
  });

  html += `</tr></thead><tbody>`;

  rows.forEach(row => {
    const target = parseFloat((row[1] || "").toString().replace(",", "."));
    html += `<tr>`;

    row.forEach((cell, idx) => {
      let cellClass = "text-center";
      const value = parseFloat((cell || "").toString().replace(",", "."));

      if (idx === 1) {
        cellClass += " bg-secondary text-white"; // kolom TARGET abu-abu
      } else if (!isNaN(value) && !isNaN(target) && value > target && idx > 1) {
        cellClass += " bg-danger text-white"; // nilai > target merah
      }

      html += `<td class="${cellClass}">${cell ?? '-'}</td>`;
    });

    html += `</tr>`;
  });

  html += `</tbody></table></div>`;
  return html;
}
function loadScc() {
  showLoading();
  document.getElementById("headerSection").style.display = "none";

  fetch(`${scriptURL}?kategori=scc`)
    .then(res => res.json())
    .then(data => {
      hideLoading();
      const container = document.getElementById("dashboardContent");

      const wilayahBanten = [
        "BJO", "BAY", "BJT", "BLJ", "BRS", "CKA", "CKD", "CLG", "CRS", "CSK", "CWN",
        "GRL", "KMT", "KRS", "LBU", "LWD", "MEN", "MER", "MLP", "PBN", "PDG", "PSU",
        "RKS", "SAG", "SAM", "SEG", "SKE", "TGR", "TJO", "DATEL CILEGON", "DATEL SERANG", "DATEL LEBAK"
      ];

      const wilayahTangerang = [
        "CKL", "CLD", "CPA", "CPD", "CUG", "GDS", "KJO", "LGK", "LKG", "MUK", "PDR",
        "PKU", "PPG", "PSK", "RJG", "RMP", "SPT", "SRH", "SRP", "TAN", "CIPUTAT",
        "LENGKONG", "PASAR BARU", "TANGERANG", "DATEL CIKUPA"
      ];

      let html = `<h4 class="text-center mb-4 fw-bold">📊 SCC COMPLIANCE</h4>`;

      // HEADER TABEL
      html += `<div class="table-responsive"><table class="table table-bordered table-sm text-center align-middle">
        <thead>
          <tr>
            <th rowspan="2" style="background-color:#000; color:#fff;">TERITORY</th>
            <th colspan="4" style="background-color:#000; color:#fff;">H-1</th>
            <th colspan="4" style="background-color:#000; color:#fff;">H</th>
            <th rowspan="2" style="background-color:#000; color:#fff;">GROWTH</th>
          </tr>
          <tr>
            <th style="background-color:#000; color:#fff;">NOT COMPLY</th>
            <th style="background-color:#000; color:#fff;">COMPLY</th>
            <th style="background-color:#000; color:#fff;">TOTAL</th>
            <th style="background-color:#000; color:#fff;">AVG 70%</th>
            <th style="background-color:#000; color:#fff;">NOT COMPLY</th>
            <th style="background-color:#000; color:#fff;">COMPLY</th>
            <th style="background-color:#000; color:#fff;">TOTAL</th>
            <th style="background-color:#000; color:#fff;">AVG 70%</th>
          </tr>
        </thead>
        <tbody>`;

      const listNotAchievedBanten = [];
      const listNotAchievedTangerang = [];

      data.forEach(row => {
        const teritory = (row[0] || "").toString().trim().toUpperCase();
        const avgH = parseFloat((row[8] || "").toString().replace(",", "."));

        html += `<tr>`;
        row.forEach((cell, idx) => {
          let style = "";
          let value = parseFloat((cell || "").toString().replace(",", "."));
          let displayValue = cell ?? "-";

          if (!isNaN(value)) {
            displayValue = value.toFixed(2);
          }

          // Pewarnaan baris khusus
          if (teritory === "BANTEN" || teritory === "TANGERANG") {
            style = "background-color:#0d6efd;color:white;";
          } else if ([
            "DATEL CIKUPA", "DATEL CILEGON", "DATEL SERANG", "DATEL LEBAK",
            "CIPUTAT", "LENGKONG", "PASAR BARU"
          ].includes(teritory)) {
            style = "background-color:#6c757d;color:white;";
          }

          // Pewarnaan kolom AVG 70% jika < 70 dan bukan baris khusus
          const isAvgColumn = (idx === 4 || idx === 8);
          if (!style && isAvgColumn && !isNaN(value) && value < 70) {
            style = "background-color:#dc3545;color:white;";
          }

          html += `<td class="text-center" style="${style}">${displayValue}</td>`;
        });
        html += `</tr>`;

        // Kumpulkan untuk bagian NOT ACHIEVED
        if (avgH < 70 && !isNaN(avgH)) {
          if (wilayahBanten.includes(teritory)) {
            listNotAchievedBanten.push({ teritory, avg: avgH });
          } else if (wilayahTangerang.includes(teritory)) {
            listNotAchievedTangerang.push({ teritory, avg: avgH });
          }
        }
      });

      html += `</tbody></table></div>`;

      // Tambahan deskripsi bawah
      html += `<div class="mt-5">
        <h5 class="fw-bold text-danger">SCC INET BANTEN – NOT ACHIEVED</h5>
        <table class="table table-bordered table-sm w-auto">
          <thead><tr style="background-color:#000;color:#fff;">
            <th>TERITORY</th><th>AVG 70%</th>
          </tr></thead><tbody>
          ${listNotAchievedBanten.map(item => `
            <tr><td>${item.teritory}</td><td>${item.avg.toFixed(2)}</td></tr>`).join("")}
          </tbody>
        </table>

        <h5 class="fw-bold text-danger mt-4">SCC INET TANGERANG – NOT ACHIEVED</h5>
        <table class="table table-bordered table-sm w-auto">
          <thead><tr style="background-color:#000;color:#fff;">
            <th>TERITORY</th><th>AVG 70%</th>
          </tr></thead><tbody>
          ${listNotAchievedTangerang.map(item => `
            <tr><td>${item.teritory}</td><td>${item.avg.toFixed(2)}</td></tr>`).join("")}
          </tbody>
        </table>
      </div>`;

      container.innerHTML = html;
    })
    .catch(err => {
      hideLoading();
      console.error("Gagal muat data SCC:", err);
      document.getElementById("dashboardContent").innerHTML =
        '<p class="text-center text-danger">Gagal memuat data SCC.</p>';
    });
}

function loadTtrHsi() {
  showLoading();
  document.getElementById('headerSection').style.display = 'none';

  Promise.all([
    fetch(scriptURL + '?kategori=DETAIL TTR RETAIL').then(res => res.json()),
    fetch(scriptURL + '?kategori=DETAIL TTR RESELLER').then(res => res.json())
  ]).then(([retail, reseller]) => {
    hideLoading();
    renderTtrHsiPivot(retail, reseller);
  }).catch(err => {
    hideLoading();
    alert("❌ Gagal memuat data TTR HSI: " + err.message);
  });
}

function renderTtrHsiPivot(retail, reseller) {
  const container = document.getElementById("dashboardContent");

  const groupByKey = (data, keys) => {
    const map = {};
    data.forEach(row => {
      const key = keys.map(k => row[k] || "").join("|");
      if (!map[key]) map[key] = [];
      map[key].push(row);
    });
    return map;
  };

  const retailGroup = groupByKey(retail, ["WITEL", "WORKZONE"]);
  const resellerGroup = groupByKey(reseller, ["WITEL", "WORKZONE"]);
  const allKeys = new Set([...Object.keys(retailGroup), ...Object.keys(resellerGroup)]);

  const witelData = { TANGERANG: [], BANTEN: [] };

  const getRows = (rows, key, isComply = true) =>
  rows.filter(r => {
    const val = (r[key] || "").toString().trim().toUpperCase();
    return isComply ? val === "COMPLY" : val === "NOT_COMPLY";
  });

  const makeLink = (val, rows) => `<td><a href="#" onclick='showIncidentDetails(${JSON.stringify(rows).replace(/'/g, "&apos;")})'>${val}</a></td>`;

  allKeys.forEach(key => {
    const [witel, workzone] = key.split("|");
    const rRows = retailGroup[key] || [];
    const sRows = resellerGroup[key] || [];

    const rowHtml = `
      <tr>
        <td>${workzone}</td>
        ${makeLink(getRows(rRows, "COMPLY_4_E2E", true).length, getRows(rRows, "COMPLY_4_E2E", true))}
        ${makeLink(getRows(rRows, "COMPLY_4_E2E", false).length, getRows(rRows, "COMPLY_4_E2E", false))}
        ${makeLink(getRows(rRows, "COMPLY_24_E2E", true).length, getRows(rRows, "COMPLY_24_E2E", true))}
        ${makeLink(getRows(rRows, "COMPLY_24_E2E", false).length, getRows(rRows, "COMPLY_24_E2E", false))}
        ${makeLink([...new Set(rRows.map(r => r.INCIDENT))].length, rRows)}
        ${makeLink(getRows(sRows, "COMPLY_6_E2E", true).length, getRows(sRows, "COMPLY_6_E2E", true))}
        ${makeLink(getRows(sRows, "COMPLY_6_E2E", false).length, getRows(sRows, "COMPLY_6_E2E", false))}
        ${makeLink(getRows(sRows, "COMPLY_36_E2E", true).length, getRows(sRows, "COMPLY_36_E2E", true))}
        ${makeLink(getRows(sRows, "COMPLY_36_E2E", false).length, getRows(sRows, "COMPLY_36_E2E", false))}
        ${makeLink([...new Set(sRows.map(r => r.INCIDENT))].length, sRows)}
      </tr>
    `;

    const witelKey = (witel || "").toUpperCase().includes("TANGERANG") ? "TANGERANG" : "BANTEN";
    witelData[witelKey].push(rowHtml);
  });

  let html = `
    <h5 class="mb-3 text-center">📊 Pivot TTR HSI dengan COMPLY / NOT_COMPLY</h5>
  `;

  Object.keys(witelData).forEach(witel => {
    html += `
      <h6 class="mt-4 text-primary">WITEL ${witel}</h6>
      <div class="table-responsive">
        <table class="table table-bordered table-sm text-center align-middle">
          <thead>
            <tr class="table-dark">
              <th rowspan="2">WORKZONE</th>
              <th colspan="5" style="background-color:#2F9948;">HSI</th>
              <th colspan="5" style="background-color:#2217B1;">RESELLER</th>
            </tr>
            <tr class="table-light">
              <th>4 JAM ✅COPLY</th>
              <th>4 JAM ❌NOT COMPLY</th>
              <th>24 JAM ✅COPLY</th>
              <th>24 JAM ❌NOT COMPLY</th>
              <th>TOTAL</th>
              <th>6 JAM ✅COPLY</th>
              <th>6 JAM ❌NOT COMPLY</th>
              <th>36 JAM ✅COPLY</th>
              <th>36 JAM ❌NOT COMPLY</th>
              <th>TOTAL</th>
            </tr>
          </thead>
          <tbody>
            ${witelData[witel].join("")}
          </tbody>
        </table>
      </div>
    `;
  });

  html += `<div id="popupDetail" class="mt-4"></div>`;
  container.innerHTML = html;
}


function showIncidentDetails(rows) {
  const container = document.getElementById("popupDetail");
  if (!rows || rows.length === 0) {
    container.innerHTML = `<div class="alert alert-warning">Tidak ada data tiket ditemukan.</div>`;
    return;
  }

  const headers = ["INCIDENT", "CUSTOMER_NAME", "SUMARY", "SERVICE_NO", "REPORTED_DATE", "WORKZONE", "SYMPTOM", "ACTUAL_SOLUTION"];

  let html = `
    <div class="card mt-4">
      <div class="card-header bg-info text-white">
        Detail Tiket (${rows.length} data)
      </div>
      <div class="card-body table-responsive p-2">
        <table class="table table-sm table-bordered">
          <thead class="table-light">
            <tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>
          </thead>
          <tbody>
            ${rows.map(row => `
              <tr>
                ${headers.map(h => `<td>${row[h] || ""}</td>`).join('')}
              </tr>`).join("")}
          </tbody>
        </table>
      </div>
    </div>`;
  container.innerHTML = html;
}
function loadTangible() {
  showLoading();
  document.getElementById('headerSection').style.display = 'none';
  fetch(`${scriptURL}?kategori=tangible`)
    .then(res => res.json())
    .then(data => {
      hideLoading();
      renderTangible(data);
    }).catch(err => {
      hideLoading();
      alert("❌ Gagal memuat data Tangible: " + err.message);
    });
}

function renderTangible(data) {
  const container = document.getElementById("dashboardContent");

  const pastelColors = [
    "#003366", "#fce4ec", "#C81300", "#319751",
    "#F69F1E", "#f1f8e9", "#f0f4c3", "#E2ED4D",
    "#e0f7fa", "#73BFFD", "#f9fbe7", "#e0f2f1",
    "#e8eaf6", "#fff8e1", "#e1f5fe", "#FF8379",
    "#ede7f6", "#fce4ec"
  ];

  const manualThead = `
    <thead>
      <tr>
        <th rowspan="2" style="background:${pastelColors[0]}; color:white; max-width:130px;">SEKTOR</th>
        <th colspan="4" style="background:${pastelColors[0]}; color:white;">PROGRES TANGIBLE ODP</th>
        <th colspan="4" style="background:${pastelColors[14]}">STATUS APPROVE ODP (TANGIBLE)</th>
        <th rowspan="2" style="background:#eee; width:10px; max-width:10px; padding:0;"></th>
        <th colspan="4" style="background:${pastelColors[0]}; color:white;">PROGRES TANGIBLE ODC</th>
        <th colspan="3" style="background:${pastelColors[14]}">STATUS APPROVE ODC</th>
      </tr>
      <tr>
        <th style="background:${pastelColors[2]}; color:white;">TARGET</th>
        <th style="background:${pastelColors[3]}; color:white;">APPROVE</th>
        <th style="background:${pastelColors[4]}">GAP s/d HI</th>
        <th style="background:${pastelColors[5]}">BLM PROGRES</th>

        <th style="background:${pastelColors[4]}">SISA TARGET 15hk</th>
        <th style="background:${pastelColors[7]}">Blm di cek</th>
        <th style="background:${pastelColors[15]}">Return</th>
        <th style="background:${pastelColors[9]}">%Kualitas</th>

        <th style="background:${pastelColors[2]}; color:white;">TARGET</th>
        <th style="background:${pastelColors[3]}; color:white;">APPROVE</th>
        <th style="background:${pastelColors[4]}">GAP s/d HI</th>
        <th style="background:${pastelColors[5]}">BLM PROGRES</th>

        <th style="background:${pastelColors[7]}">Blm di cek</th>
        <th style="background:${pastelColors[15]}">Return</th>
        <th style="background:${pastelColors[9]}">%Kualitas</th>
      </tr>
    </thead>
  `;

  const renderTable = (dataRows, totalRow, title) => {
    if (!dataRows.length) return "";

    let html = `
      <h6 class="mt-4 text-uppercase text-primary">${title}</h6>
      <div class="table-responsive">
        <table class="table table-bordered table-sm text-center align-middle"
               style="table-layout:fixed; width:100%; font-size:12px;">
          ${manualThead}
          <tbody>`;

    // Baris data
    dataRows.forEach(row => {
      html += `<tr>`;
      row.forEach((cell, colIdx) => {
        if (colIdx === 1) return;

        let val = cell ?? "";

        // Bersihkan SEKTOR prefix
        if (colIdx === 0 && typeof val === "string") {
  val = val
    .replace(/^SEKTOR\s*-\s*TANGERANG\s*-\s*/i, "")
    .replace(/^SEKTOR\s*-\s*BANTEN\s*-\s*/i, "");

  // Ganti nama panjang jadi singkatan
  val = val
    .replace(/PASAR KEMIS 1/i, "PSK 1")
    .replace(/PASAR KEMIS 2/i, "PSK 2")
    .replace(/TANGERANG 1/i, "TAN 1")
    .replace(/TANGERANG 2/i, "TAN 2")
    .replace(/PONDOK AREN/i, "PDK AREN")
    .replace(/GANDASARI 1/i, "GDS 1")
    .replace(/GANDASARI 2/i, "GDS 2")
    .replace(/PARUNG PANJANG/i, "P.PANJANG")
    .replace(/LENGKONG 1/i, "LKG 1")
    .replace(/LENGKONG 2/i, "LKG 2")
    .replace(/PANDEGLANG 1/i, "PDG 1")
    .replace(/PANDEGLANG 2/i, "PDG 2")
    .replace(/RANGKASBITUNG/i, "RANGKAS");
}
        const num = parseFloat(val.toString().replace(",", "."));
        const isNegative = !isNaN(num) && num < 0;
        const style = isNegative ? 'background-color:#f8d7da;' : '';

        const width = colIdx === 0 ? 'max-width:130px;' :
                      colIdx === 9 ? 'max-width:10px; width:10px; padding:0;' : '';

        html += `<td style="word-break:break-word; padding:4px; ${width} ${style}">${val}</td>`;
      });
      html += `</tr>`;
    });

    // Baris TOTAL
    if (totalRow && totalRow.length) {
      html += `<tr>`;
      totalRow.forEach((val, idx) => {
        if (idx === 1) return;

        const fixed = typeof val === "number" && !Number.isInteger(val) ? val.toFixed(2) : val;
        html += `<td style="background:#003366; color:white; font-weight:bold; font-size:12px; padding:4px;">${fixed}</td>`;
      });
      html += `</tr>`;
    }

    html += `</tbody></table></div>`;
    return html;
  };

  const html = `
    <h5 class="text-center mb-4">📊 TANGIBLE STATUS</h5>
    ${renderTable(data.data_tangerang, data.total_tangerang, "TANGERANG")}
    ${renderTable(data.data_banten, data.total_banten, "BANTEN")}
  `;

  container.innerHTML = html;
}

function loadLaporanWA() {
  showLoading();
  document.getElementById('headerSection').style.display = 'none';

  Promise.all([
    fetch(`${scriptURL}?kategori=laporan wa`).then(res => res.json()),
    fetch(`${scriptURL}?kategori=laporan acceptance`).then(res => res.json())
  ])
  .then(([data, acceptance]) => {
    hideLoading();

    const container = document.getElementById("dashboardContent");
    const text1 = formatLaporanGridText(data.laporan1, "📌 *LAPORAN 1*");
    const text2 = formatLaporanGridText(data.laporan2, "📊 *LAPORAN 2*");
    const text3 = formatLaporanGridText(data.laporan3, "📝 *LAPORAN 3*");
    const text4 = formatLaporanWithSlashes(acceptance, "📦 *LAPORAN 4: ACCEPTANCE*");

    container.innerHTML = `
      <h4 class="text-center mb-4 fw-bold">📩 Laporan WA Team</h4>
      ${renderLaporanCard("Laporan 1", text1, "primary")}
      ${renderLaporanCard("Laporan 2", text2, "success")}
      ${renderLaporanCard("Laporan 3", text3, "info")}
      ${renderLaporanCard("Laporan 4", text4, "warning")}
      <div class="text-center mt-3">
        <button class="btn btn-outline-dark fw-bold salin-semua">📋 Salin Semua Laporan</button>
      </div>
    `;

    initBootstrapToasts();

    document.querySelectorAll(".salin-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-target");
        const teks = document.getElementById(id).innerText;
        salinKeClipboard(teks);
      });
    });

    document.querySelector(".salin-semua").addEventListener("click", () => {
      salinKeClipboard(`${text1}\n\n${text2}\n\n${text3}\n\n${text4}`);
    });
  })
  .catch(err => {
    hideLoading();
    console.error("Gagal muat laporan:", err);
    document.getElementById("dashboardContent").innerHTML = '<p class="text-danger text-center">Gagal memuat laporan.</p>';
  });
}

function renderLaporanCard(judul, teks, warna) {
  const id = `laporan-${judul.replace(/\s+/g, '-').toLowerCase()}`;
  return `
    <div class="card border-${warna} mb-4 shadow-sm">
      <div class="card-header bg-${warna} text-white fw-bold d-flex justify-content-between align-items-center">
        <span>📋 ${judul}</span>
        <button class="btn btn-light btn-sm fw-semibold salin-btn" data-target="${id}">
          📎 Salin ke Clipboard
        </button>
      </div>
      <div class="card-body bg-light">
        <pre id="${id}" style="white-space:pre; font-family:monospace; font-size: 0.85rem;" class="m-0">${teks}</pre>
      </div>
    </div>
  `;
}

function salinKeClipboard(teks) {
  const textarea = document.createElement("textarea");
  textarea.value = teks;
  textarea.setAttribute("readonly", "");
  textarea.style.position = "fixed";
  textarea.style.opacity = 0;
  document.body.appendChild(textarea);
  textarea.focus();
  textarea.select();

  try {
    const sukses = document.execCommand('copy');
    if (sukses) {
      showToast();
    } else {
      alert("❌ Gagal menyalin. Silakan salin manual.");
    }
  } catch (err) {
    alert("❌ Clipboard tidak tersedia.");
    console.error("execCommand error:", err);
  }

  document.body.removeChild(textarea);
}

function showToast() {
  const toastEl = document.querySelector("#toastCopy .toast");
  const toast = bootstrap.Toast.getOrCreateInstance(toastEl);
  toast.show();
}

function initBootstrapToasts() {
  document.querySelectorAll('.toast').forEach(toastEl => {
    bootstrap.Toast.getOrCreateInstance(toastEl, { delay: 2000 });
  });
}

function formatLaporanGridText(data, title) {
  if (!data || data.length === 0) return "";

  const maxCols = data[0].length;
  const colWidths = Array(maxCols).fill(0);

  data.forEach(row => {
    row.forEach((cell, i) => {
      const val = formatCell(cell);
      if (val.length > colWidths[i]) {
        colWidths[i] = val.length;
      }
    });
  });

  const formatRow = row => {
    return row.map((cell, i) => {
      const val = formatCell(cell);
      return val.padEnd(colWidths[i]);
    }).join("  ");
  };

  const lines = data.map(formatRow);
  while (lines.length > 0 && lines[0].match(/\d{2} [A-Za-z]+ \d{4}.*\d{2}[:.]\d{2}/)) {
    lines.shift();
  }

  return `${title}\n` + lines.join("\n");
}

function formatLaporanWithSlashes(data, title) {
  if (!data || data.length === 0) return "";

  // Buang baris kosong dari data
  const cleanData = data.filter(row =>
    row.some(cell => (cell ?? "").toString().trim() !== "")
  );

  const maxCols = Math.max(...cleanData.map(r => r.length));
  const colWidths = Array(maxCols).fill(0);

  // Hitung lebar kolom hanya dari baris data (bukan subjudul)
  cleanData.forEach(row => {
    const isSubjudul = row.length === 1 || (row[0] && typeof row[0] === "string" && row[0].startsWith("*"));
    if (isSubjudul) return;
    for (let i = 0; i < maxCols; i++) {
      const val = formatCell(row[i] ?? "");
      colWidths[i] = Math.max(colWidths[i], val.length);
    }
  });

  // Format baris
  const lines = cleanData.map(row => {
    const isSubjudul = row.length === 1 || (row[0] && typeof row[0] === "string" && row[0].startsWith("*"));
    if (isSubjudul) {
      return formatCell(row[0]);
    }

    const paddedRow = [...row];
    while (paddedRow.length < maxCols) paddedRow.push("");
    return paddedRow.map((cell, i) => {
      const val = formatCell(cell);
      return val.padEnd(colWidths[i]);
    }).join(" / ");
  });

  return `${title}\n` + lines.join("\n");
}


function formatCell(cell) {
  if (cell instanceof Date) return formatTanggal(cell);
  if (typeof cell === 'string' && cell.match(/^\d{4}-\d{2}-\d{2}T/)) return formatTanggalWaktuLengkap(new Date(cell));
  return (cell ?? "").toString();
}

function formatTanggal(tgl) {
  try {
    const d = new Date(tgl);
    return d.toLocaleDateString("id-ID", { day: "2-digit", month: "short", year: "numeric" });
  } catch { return tgl; }
}

function formatTanggalWaktuLengkap(tgl) {
  try {
    return tgl.toLocaleString("id-ID", {
      weekday: "long", year: "numeric", month: "long", day: "numeric",
      hour: "2-digit", minute: "2-digit", second: "2-digit", hour12: false
    }).replace(",", "").replace("pukul", "pukul");
  } catch { return tgl; }
}

</script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div id="toastCopy" class="position-fixed bottom-0 end-0 p-3" style="z-index: 1055;">
  <div class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body">✅ Laporan berhasil disalin ke clipboard!</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>
</body>
</html>	
